<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Wikipedia Graph Crawler</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
            background: #1a1a1a;
        }

        #graph {
            width: 100vw;
            height: 100vh;
        }

        .node {
            cursor: pointer;
            transition: r 0.3s;
        }

        .node:hover {
            stroke: #fff;
            stroke-width: 3px;
        }

        .link {
            stroke: #999;
            stroke-opacity: 0.6;
            stroke-width: 2px;
        }

        .node-label {
            fill: #fff;
            font-size: 10px;
            pointer-events: none;
            text-shadow: 0 0 3px #000;
        }

        #stats {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 15px;
            border-radius: 5px;
            font-size: 14px;
        }

        #status {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 12px;
        }

        .connected { color: #4CAF50; }
        .disconnected { color: #f44336; }
    </style>
</head>
<body>
    <div id="stats">
        <div>Nodes: <span id="node-count">0</span></div>
        <div>Edges: <span id="edge-count">0</span></div>
    </div>
    <div id="status">
        <span id="connection-status" class="disconnected">Disconnected</span>
    </div>
    <svg id="graph"></svg>

    <script>
        const width = window.innerWidth;
        const height = window.innerHeight;

        const svg = d3.select("#graph")
            .attr("width", width)
            .attr("height", height);

        const g = svg.append("g");

        // Add zoom behavior
        const zoom = d3.zoom()
            .scaleExtent([0.1, 10])
            .on("zoom", (event) => {
                g.attr("transform", event.transform);
            });

        svg.call(zoom);

        const graphData = {
            nodes: [],
            links: []
        };

        const nodeMap = new Map();

        // Create force simulation
        const simulation = d3.forceSimulation()
            .force("link", d3.forceLink().id(d => d.id).distance(100))
            .force("charge", d3.forceManyBody().strength(-300))
            .force("center", d3.forceCenter(width / 2, height / 2))
            .force("collision", d3.forceCollide().radius(30));

        let linkSelection = g.append("g").selectAll(".link");
        let nodeSelection = g.append("g").selectAll(".node");
        let labelSelection = g.append("g").selectAll(".node-label");

        function updateGraph() {
            // Update links
            linkSelection = linkSelection.data(graphData.links, d => `${d.source.id}-${d.target.id}`);
            linkSelection.exit().remove();
            const linkEnter = linkSelection.enter()
                .append("line")
                .attr("class", "link");
            linkSelection = linkEnter.merge(linkSelection);

            // Update nodes
            nodeSelection = nodeSelection.data(graphData.nodes, d => d.id);
            nodeSelection.exit().remove();
            const nodeEnter = nodeSelection.enter()
                .append("circle")
                .attr("class", "node")
                .attr("r", 8)
                .attr("fill", d => d.id === "root" ? "#ff6b6b" : "#4ecdc4")
                .call(drag(simulation));
            
            nodeSelection = nodeEnter.merge(nodeSelection);

            // Update labels
            labelSelection = labelSelection.data(graphData.nodes, d => d.id);
            labelSelection.exit().remove();
            const labelEnter = labelSelection.enter()
                .append("text")
                .attr("class", "node-label")
                .attr("dx", 12)
                .attr("dy", 4)
                .text(d => d.id.replace(/_/g, ' ').substring(0, 20));
            
            labelSelection = labelEnter.merge(labelSelection);

            // Update simulation
            simulation.nodes(graphData.nodes);
            simulation.force("link").links(graphData.links);
            simulation.alpha(0.3).restart();

            // Update stats
            document.getElementById("node-count").textContent = graphData.nodes.length;
            document.getElementById("edge-count").textContent = graphData.links.length;
        }

        simulation.on("tick", () => {
            linkSelection
                .attr("x1", d => d.source.x)
                .attr("y1", d => d.source.y)
                .attr("x2", d => d.target.x)
                .attr("y2", d => d.target.y);

            nodeSelection
                .attr("cx", d => d.x)
                .attr("cy", d => d.y);

            labelSelection
                .attr("x", d => d.x)
                .attr("y", d => d.y);
        });

        function drag(simulation) {
            function dragstarted(event) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                event.subject.fx = event.subject.x;
                event.subject.fy = event.subject.y;
            }

            function dragged(event) {
                event.subject.fx = event.x;
                event.subject.fy = event.y;
            }

            function dragended(event) {
                if (!event.active) simulation.alphaTarget(0);
                event.subject.fx = null;
                event.subject.fy = null;
            }

            return d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended);
        }

        // WebSocket connection
        const ws = new WebSocket('ws://127.0.0.1:8081/ws');

        ws.onopen = () => {
            console.log('Connected to crawler');
            document.getElementById("connection-status").textContent = "Connected";
            document.getElementById("connection-status").className = "connected";
        };

        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            
            if (data.type === "NodeAdded") {
                if (!nodeMap.has(data.id)) {
                    const node = { id: data.id };
                    graphData.nodes.push(node);
                    nodeMap.set(data.id, node);
                    updateGraph();
                }
            } else if (data.type === "EdgeAdded") {
                const sourceNode = nodeMap.get(data.source);
                const targetNode = nodeMap.get(data.target);
                
                if (sourceNode && targetNode) {
                    graphData.links.push({
                        source: sourceNode,
                        target: targetNode
                    });
                    updateGraph();
                }
            } else if (data.type === "CrawlComplete") {
                console.log('Crawl complete');
            }
        };

        ws.onerror = (error) => {
            console.error('WebSocket error:', error);
        };

        ws.onclose = () => {
            console.log('Disconnected from crawler');
            document.getElementById("connection-status").textContent = "Disconnected";
            document.getElementById("connection-status").className = "disconnected";
        };
    </script>
</body>
</html>
